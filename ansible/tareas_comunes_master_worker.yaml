- name: Tareas comunes a realizar en el nodo master y los workers
  hosts: master,worker
  become: yes
  vars_files:
    - 'group_vars/kubernetes.yaml'
  tasks:
    - name: Configuration DNS Servers
      blockinfile: 
        path: /etc/hosts
        insertafter: EOF
        block: |
          {{ item.ip }} {{ item.name }}
        marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item.name }}"
      loop:
        - { name: master, ip: 104.214.238.26 }
        - { name: worker01, ip: 104.214.238.87 }
        # - { name: worker02, ip: 10.10.1.12 }
        - { name: nfs, ip: 104.214.238.141 }

    - name: Activar transparent masquerading [1] - br_netfilter
      modprobe:
        name: br_netfilter
        state: present 

    - name: Activar transparent masquerading [2] - Habilitar el Firewall
      systemd:
        name: firewalld    
        enabled: yes
        state: started  

    - name: Activar transparent masquerading [2] - Configurar Firewall
      firewalld:
        masquerade: yes
        state: enabled
        permanent: yes
        immediate: yes

    - name: Activar transparent masquerading [2] - Reiniciar el Firewall
      systemd:
        name: firewalld    
        state: reloaded

    - name: Habilitar trafico cortafuegos [1] - Touch k8s.conf
      file:
        path: /etc/sysctl.d/k8s.conf
        state: touch

    - name: Habilitar trafico cortafuegos [1] - Write k8s.conf
      blockinfile:
        path: /etc/sysctl.d/k8s.conf
        insertafter: EOF
        block: |
          net.bridge.bridge-nf-call-ip6tables = 1
          net.bridge.bridge-nf-call-iptables = 1

    - name: Handle Traffic(3) - Reload sysctl
      shell: sysctl --system

    - name: Desactivar Swap
      shell: swapoff -a

    - name: Modificar fichero /etc/fstab/
      shell: sed -i '/swap/d' /etc/fstab
      args:
        warn: false      